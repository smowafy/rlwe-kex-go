package polynomial

import (
	"math"
	"reflect"
	"testing"
	"github.com/smowafy/rlwe-kex-go/utils"
)

func TestNussbaumer(t *testing.T) {
	cases := 1

	for ; cases > 0; cases-- {
		coefs := make([]uint32, 1024)

		for i := range coefs {
			coefs[i] = uint32(utils.RandomBit()) * EnsureMod(utils.RandomUInt32(utils.NewRandomGenerator()))
		}

		acoef := NussbaumerPolynomial(coefs)

		fft := NussbaumerTransform(acoef)

		inv := NussbaumerInverseTransform(fft)

		if !reflect.DeepEqual(acoef, inv) {
			t.Errorf("fft failed\nexpected %v\ngot %v\n", acoef, inv)
		}
	}
}

func TestNussbaumerIterative(t *testing.T) {
//	coefsArray := NewRandomPolynomial()
//	coefs := coefsArray[:]

	coefs := [][]uint32 {
		[]uint32 { 0, 4, 8, 12 },
		[]uint32 { 1, 5, 9, 13 },
		[]uint32 { 2, 6, 10, 14 },
		[]uint32 { 3, 7, 11, 15 },
	}


//	coefs := []uint32 { 1, 3, 2, 5, 0, 0, 0, 0 }

	acoef := coefs
	// acoef2 := NussbaumerIterativeReorderPolynomial(coefs)
	acoef2 := make([][]uint32, len(acoef))

	for i, v := range acoef {
		acoef2[i] = make([]uint32, len(acoef[i]))
		copy(acoef2[i], v)
	}

	acoef2 = NussbaumerIterativeReorderPolynomial(acoef2)


	fft := NussbaumerTransform(acoef)
	fftIter := NussbaumerIterativeTransform(acoef2)

	if !reflect.DeepEqual(fft, fftIter) {
		t.Errorf("Different fft coefficients, expected %v but got %v\n", fft, fftIter)
		return
	}

	inv := NussbaumerInverseTransform(fft)

	fftIter = NussbaumerIterativeReorderPolynomial(fftIter)

	t.Logf("fftIter = %v\n", fftIter)

	invIter := NussbaumerIterativeInverseTransform(fftIter)

	if !reflect.DeepEqual(inv, invIter) {
		t.Errorf("Different coefficients, expected %v but got %v\n", inv, invIter)
	}
}

func BenchmarkNussbaumerIterative(b *testing.B) {
	coefficients := make([]uint32, 1024)

	for i := 0; i < len(coefficients); i++ {
		coefficients[i] = EnsureMod(utils.RandomUInt32(utils.NewRandomGenerator()))
	}

	acoef := NussbaumerPolynomial(coefficients)

	acoef = NussbaumerIterativeReorderPolynomial(acoef)

	b.ResetTimer()

	NussbaumerIterativeTransform(acoef)
}


func BenchmarkNussbaumerIterativeInverse(b *testing.B) {
	coefficients := make([]uint32, 1024)

	for i := 0; i < len(coefficients); i++ {
		coefficients[i] = EnsureMod(utils.RandomUInt32(utils.NewRandomGenerator()))
	}

	acoef := NussbaumerPolynomial(coefficients)
	acoef = NussbaumerIterativeReorderPolynomial(acoef)

	b.ResetTimer()

	NussbaumerIterativeInverseTransform(acoef)
}

func BenchmarkPolyMultiply(b *testing.B) {
	a0 := NewRandomPolynomial()
	a1 := NewRandomPolynomial()

	b.ResetTimer()

	a0.Multiply(a1)
}

func TestPolyMultiply(t *testing.T) {

	p1 := Polynomial{
		2290161843, 1502266578, 3044885867, 15425721, 2839089316, 4114567907, 3997559913, 1549701630, 140075611,
		554776049, 296509263, 170350885, 387815849, 3073155765, 600322586, 703594638, 3019197442, 75295900,
		4024088301, 3715479412, 129851843, 2168053456, 2638727338, 2931355281, 494158999, 1843198336, 3524912000,
		3988899252, 3116950379, 3073850425, 3934248470, 1945754961, 1490447821, 4177882156, 1157404019, 1501641614,
		2605880923, 3546775868, 471574408, 3457932968, 3018886175, 1145182773, 2954546781, 179487556, 699089871,
		3737608140, 3787200392, 1315328481, 106842764, 1724877689, 3293415315, 3092124729, 2250960966, 1435920862,
		3405509703, 2755270653, 4000099301, 3841598305, 4100506214, 3109887378, 1189511543, 282112568, 3957987600,
		213043967, 70308880, 2421878275, 1677234108, 3376855844, 2191042361, 2788600184, 2982287982, 235958436,
		602587389, 547669668, 664101873, 4223340176, 2797864032, 2239840471, 842355118, 907480988, 3032580091,
		3193741917, 1279909625, 3427927439, 239962883, 978860953, 3546171430, 2520707245, 3366684268, 1536825355,
		1008314523, 2267815063, 687271647, 2926458710, 3104841299, 677161777, 1754196173, 2139203249, 2293896734,
		1167938594, 1389256600, 736817313, 670064793, 1771625887, 2695287394, 2206140854, 420342639, 2623986927,
		2447016892, 509049200, 3669961623, 3213785114, 3264496861, 1899139766, 3466815098, 2417533040, 1015756200,
		3111514595, 2008345351, 1252763718, 924097854, 1936932069, 3812061937, 1995886046, 3318017893, 1789109438,
		196772635, 905841425, 2852060196, 3380978912, 2674730436, 3205363586, 1770377305, 2880716061, 1277054107,
		4286729948, 568949807, 1357222351, 2562803163, 1664971375, 1010371142, 1368736980, 1603771500, 3845197529,
		1368612622, 4108019516, 1483262062, 949727047, 2401389418, 1136484419, 3091216258, 3534332571, 4084936385,
		2436362123, 3783635733, 2731100409, 3134844202, 1940947414, 3853273275, 2208697462, 2920568770, 447160218,
		559654945, 8648649, 3546405303, 1543236923, 4021002679, 3110620563, 2399984041, 2503738916, 2466426992,
		3639776923, 4017956309, 3858513443, 3053435334, 2705384349, 768247294, 444629525, 4084552349, 1276839138,
		2020973891, 3189347383, 1086239065, 929720863, 2423063445, 186085438, 3912429152, 1640978235, 636545257,
		3609683947, 187781434, 508855503, 560709618, 4245548846, 116465768, 282228619, 2955413941, 4211935365,
		3998735782, 3819612670, 2770022769, 2545193507, 1070834814, 2507599197, 172599368, 956731926, 3784905554,
		2430444209, 2165094998, 2433582474, 3667999664, 1394746058, 2740937750, 406990978, 211158278, 1386361299,
		3495970369, 3347561795, 2436463819, 1408434789, 3773062001, 3875805298, 1755779700, 2241976928, 1449188358,
		2417181140, 785751228, 2218600550, 1487457849, 4272232357, 2434289272, 1882429174, 2174855914, 2885864157,
		1022099104, 4110237601, 1719124850, 2349303872, 1991968947, 649200400, 2442880430, 2356401165, 3566572543,
		1683719056, 179388669, 4117877547, 1395995787, 298496112, 4124184751, 1746396406, 3513031838, 3483146390,
		538808888, 938703518, 1016536020, 711670772, 1712141663, 3021974652, 1276223956, 470074924, 2456870550,
		3981559406, 3733112169, 1733439210, 2648274467, 658556572, 1419095757, 2764640199, 2386391822, 1100529722,
		2418677344, 3530770778, 3553102678, 217255055, 2041359561, 3106715831, 878212679, 831611826, 1465327233,
		849289080, 190173179, 2249043180, 3057481774, 4214707485, 3433896811, 820620569, 1547845955, 3817476420,
		1158686864, 3092181214, 539025024, 3428444548, 990678704, 2088235104, 2976362699, 1003990721, 967498864,
		3539069182, 888626260, 1583857795, 2823609485, 3558165722, 752658089, 814655588, 4235879981, 701460868,
		4249584713, 1656766120, 3819000210, 3474349595, 3006780596, 3348691614, 2772855225, 85000743, 3899824792,
		1418211178, 1479608734, 1504311477, 3942281925, 463642239, 4132998086, 2440066811, 1494748680, 3711887777,
		686048739, 1447662018, 1854528356, 2248106233, 738454981, 3481995274, 4175995653, 2191633400, 2453756074,
		2001508002, 3732300684, 363440223, 2636884353, 716232928, 3000515892, 569305033, 3569013278, 3461922294,
		2763486501, 704386641, 1734870472, 1502523094, 3771071074, 1533107519, 3997436030, 2791936446, 3876367490,
		1704735432, 890229286, 393567533, 4233246612, 1555004793, 217148691, 3126230603, 3526000336, 805433285,
		681134544, 223163184, 893261629, 2200711904, 2766238028, 3352552666, 3148502554, 1665273711, 298761990,
		3400746716, 3943058973, 369953038, 2399617987, 607430203, 3251982781, 687433042, 2893133164, 2811054378,
		659506985, 1171857194, 80514281, 3733103801, 2532471229, 1407658098, 1050615811, 3232573452, 3102089951,
		4248162840, 2394564591, 433209078, 2348401289, 193759208, 72450969, 3770858365, 1882546041, 1377978859,
		2992539216, 63621072, 2325614191, 2582004679, 3889985651, 2069089631, 1170267609, 1478820765, 4002623642,
		2131265835, 2631385559, 3246984898, 1868287207, 2221825860, 2777191598, 3583937895, 1442592664, 3821990281,
		3768987130, 1385231389, 1056143812, 4185097050, 634779881, 2499433379, 53953330, 1892438900, 1021410734,
		3497159189, 1621207762, 3743471530, 2939078461, 2182318487, 259604298, 675423447, 2657606740, 3405221855,
		774912096, 1772981000, 1351178494, 1016770749, 1684395964, 493063123, 4177217583, 3312035038, 3535252105,
		2377863849, 767936962, 174643118, 686454943, 301933772, 1049753035, 3325425093, 69995320, 3156272862,
		57987878, 1938970484, 1710148665, 2634415481, 2197438971, 1425367569, 3501179038, 1441379291, 1242091631,
		3840065222, 822605627, 1368602265, 2293480227, 1346174205, 336440102, 3562975907, 2798358944, 1613999747,
		4200996715, 1196865336, 1373670755, 4167342175, 241546252, 3902919519, 83395651, 287664910, 2141544068,
		3693897166, 3682406879, 3969682993, 4280705827, 1713630483, 1601914889, 4035614531, 3937938185, 1640131529,
		175416412, 2291135272, 4258293951, 3445420074, 2751217481, 181093974, 524976845, 1015763167, 2791038919,
		1866639564, 4253910461, 3189694711, 148457811, 440331, 1787233699, 4098359128, 2452477458, 871737238,
		3386421988, 1135273394, 2718241923, 4060382043, 2185232287, 3295096370, 4045209955, 1047875943, 2271084451,
		3206789799, 209917298, 3899284496, 681607842, 454911161, 1470862199, 1825409257, 2171131571, 2605661977,
		4122555207, 3296461351, 1297864781, 1100835353, 794567823, 525103566, 2430790611, 1091637140, 955263307,
		2061846178, 914667284, 1396442235, 3820367988, 2996346672, 4271508560, 1137045324, 1507646605, 1517462863,
		694558313, 2241676620, 3360991893, 2267175049, 658044985, 3933633291, 2286271564, 714669055, 2085066417,
		268124602, 1260965221, 1930916403, 337170523, 2294665046, 1894206300, 1677321701, 1555059847, 2428539356,
		235691139, 1259633084, 2384693652, 1437512519, 1781357665, 3062495999, 2076906381, 2952970650, 94948323,
		2207086021, 870311035, 1586021568, 4241872714, 2042510744, 2242616632, 529737620, 3169365640, 322048817,
		2694837435, 2944974079, 494376536, 258796211, 615799665, 2703021119, 3627206071, 469521592, 1910907482,
		142594837, 948020797, 2844474547, 2474125186, 148026890, 2431039423, 166381839, 182061166, 3237526650,
		2318174290, 1861732488, 3088847912, 661831130, 2781200134, 2159651726, 1490070074, 134526375, 4042320155,
		1751681669, 847254535, 1710384760, 1498928454, 276323060, 3574980108, 3619241288, 391912897, 3449992564,
		438449583, 2314058355, 1369473863, 1408863696, 987071943, 2407969806, 1115185136, 816226300, 1239157915,
		2159582510, 1056171339, 80002019, 2310433223, 92272507, 3908510798, 1863450850, 303971378, 1495413887,
		578101378, 1939199518, 832709367, 459074201, 4275585618, 3244485847, 137480483, 264103761, 3170228748,
		3647688630, 2066996226, 3712295003, 3197783554, 3416676144, 3797670151, 2954608621, 3714790934, 3656910667,
		3933401308, 4269925451, 3986966759, 1132098409, 4294661325, 3557903045, 89812215, 2386196349, 94699358,
		1864076365, 2295329182, 3676076628, 1107889566, 1453095374, 4269834458, 1859034149, 4132195899, 3075129883,
		765095960, 331891839, 105208391, 1646136517, 797762966, 5138145, 1099089067, 1251900734, 2851598045,
		4014225786, 1172558952, 2852681275, 3555651918, 953485975, 760379103, 3676518298, 1725128025, 1011830926,
		1579841581, 3443643600, 3778562191, 3327604400, 145408201, 964100210, 2691804132, 3828789301, 3492278121,
		1528524068, 2170939810, 3281466748, 1695928610, 2669476933, 1645373427, 3749342540, 2509073196, 820981400,
		2183259931, 2529260749, 58323175, 2202821349, 602851233, 4224553382, 2724223677, 3775129889, 290640952,
		4036487820, 1570779958, 4237145428, 2251892131, 2781344292, 2143862052, 1952025300, 1962677917, 2426868436,
		2403091883, 682870389, 3701269877, 3700827134, 3240980941, 2315374148, 970101635, 2785365872, 1351598757,
		1000044568, 3909821823, 4053906475, 1325456716, 2801288887, 19700829, 690697585, 1105495976, 825208492,
		2627667898, 750485831, 3324199725, 1099246290, 1507144692, 4245285079, 727571584, 3346920800, 3419847294,
		3375394044, 2777941386, 305210338, 2973669991, 2170574249, 1976757748, 3891257740, 1495564413, 2209560191,
		2680558713, 2491469059, 4164268050, 2445678759, 677736335, 1338899355, 4128387116, 3377905519, 1348379174,
		2981677216, 2486390119, 2965719059, 817442728, 71801111, 671027702, 2379509059, 473401545, 3509759489,
		3976878094, 3011952197, 170058678, 4030089719, 1555437573, 3140187505, 890816292, 112200106, 1048015879,
		3197272107, 2132333811, 2492138228, 1034086164, 3286785869, 1496111642, 3830056071, 2602043338, 2296786482,
		896190747, 2362864202, 3724548096, 1069533755, 709333439, 2293564147, 2469696123, 3490120022, 3779807472,
		826753042, 3946725071, 2199042315, 3804535535, 4042277753, 4148301524, 1950786257, 4180429231, 1495152897,
		1668685395, 3439950648, 135368544, 2524209263, 3211466862, 3025591298, 2684027277, 613597211, 1531279690,
		2606613881, 94372597, 298861304, 922715597, 2972297549, 316109021, 3381557769, 375944596, 2292232035,
		3709259448, 4066484212, 1249737820, 2528643374, 3414563137, 1608391707, 3661428160, 2642865282, 3911330411,
		3936535162, 3927546779, 2442178590, 1683961226, 1045435475, 3597841277, 3903964165, 3989165250, 1807013411,
		2901102995, 2193588653, 3710738519, 2636295919, 2643228683, 624557359, 1437786638, 1388912261, 418275183,
		894963797, 3422576657, 2149572081, 3547269813, 1307761130, 149367439, 2701388012, 1421187677, 1768581927,
		1402866952, 3723509751, 1832931408, 2367717369, 2452530574, 1722944111, 487233505, 4063188494, 4123483669,
		3457464942, 2156489230, 992355696, 3694937204, 1685117104, 1095411675, 4119551353, 3706670352, 132517164,
		819254609, 3741480819, 3530482747, 3334986790, 3690390602, 3797135727, 3159307805, 3191968940, 1662662918,
		1753793090, 3965326123, 1529980645, 1055612381, 3691415118, 3606647766, 2452112887, 2201008129, 4180500627,
		3335105571, 4146509790, 3492339798, 208905979, 1193584986, 3407040218, 1764548622, 2036342415, 1386031385,
		595395472, 2913137758, 450281583, 2952943523, 737455761, 3179133500, 3800241973, 472449404, 618319356,
		2431772517, 330137043, 1529649476, 951732006, 3110511588, 3858854993, 1489487255, 3603968985, 3097013316,
		463104919, 2188598871, 1369738007, 3212348837, 353892598, 917780653, 2367523852, 1265061189, 2626623396,
		1646866223, 2641254814, 1417686120, 3620140325, 1363327894, 1222239398, 2758829364, 483974339, 24316149,
		146541618, 3745590957, 298836375, 1172752261, 3831342774, 596127601, 3098582473, 4124039589, 216252469,
		3405748353, 2920068086, 4043537653, 982500646, 3255605124, 2057964968, 1792544055, 1864408048, 3716025064,
		2730781577, 3260526253, 359351942, 2641422508, 1940165192, 305404652, 2983368531, 672495628, 3153065875,
		830301134, 4116584600, 2453353413, 3486215904, 810498430, 3185334494, 489994605, 3127524638, 480146769,
		3195307169, 1916276495, 2846868645, 254657878, 310939683, 2190484345, 2426819182, 1118365234, 3567896483,
		1576959377, 2745576332, 3953663827, 3961204669, 2857090083, 2333200826, 27848039, 290850273, 1880115304,
		809271053, 320763155, 3465124600, 325337771, 4083599426, 2282142440, 1844152272, 1353974029, 3994942443,
		4104568579, 374523033, 1302075977, 2074973339, 4245799228, 953484442, 1981214689, 810218170, 2409062455,
		889715032, 131319948, 1751651693, 1885362270, 1760425359, 1829248110, 415019111,
	}

	expectedRes := Polynomial{
		3278793406, 1369117525, 3756610447, 2032978779, 1910294592, 3158199183, 1235607807, 2851810365, 2314300604,
		1603150750, 2426687539, 4012261761, 1054719540, 148304551, 44678601, 3504693822, 1962556653, 3236741047,
		2595944829, 3848453337, 606022416, 234278635, 2235438915, 3384741259, 2328374883, 794055706, 4088524202,
		1114404327, 401598823, 912720580, 3300233386, 1807107709, 3102803763, 2313506372, 114081378, 3386060024,
		1294202591, 3703892504, 3723997491, 129904581, 25438920, 2245553124, 3468508884, 2734384606, 3311810718,
		2632193902, 1150341216, 979914627, 2528079759, 2965668031, 2590374028, 2832693401, 315393043, 1987491849,
		2328137555, 658232564, 2292817876, 35574481, 4018870884, 2434735913, 3373470131, 2508508043, 361665783,
		3277483173, 2148528127, 873857593, 3085707251, 2655778029, 2159662589, 2141615630, 1061311888, 3517067809,
		3287147894, 3428277325, 3112284421, 1529092431, 1785080935, 1110891968, 3548917501, 1004606018, 3056992173,
		3292762723, 3344566634, 2706410034, 2903750426, 4126633972, 102045309, 2357374790, 3851893724, 3414192138,
		1990038194, 3336780699, 2787752888, 2120826174, 1858248282, 2734194597, 4070837101, 3907554418, 895278951,
		771379460, 3762730199, 3391710130, 35741017, 3217472086, 1443866462, 2586655067, 2344148354, 2596197966,
		955709560, 2983308018, 4025572012, 4066721714, 653880115, 347587641, 3214910349, 4066037853, 3786017756,
		889097050, 3026480828, 2457866500, 2592237151, 4142978856, 3766258218, 1824592215, 3823670763, 461977491,
		3755002729, 1558525909, 239562579, 1126626447, 4273199138, 2833735140, 3879671768, 4192700778, 1819274124,
		2467582145, 468563863, 1895327297, 2111188814, 2601475666, 964658500, 4161317053, 3271296229, 2837321060,
		1493807045, 3093711515, 4100300024, 1619600581, 1651485418, 1862470207, 3589242972, 2390915709, 3812939024,
		1422610940, 2535095774, 3281993242, 4235358492, 999153179, 3735436590, 300788241, 3676341587, 825390725,
		2227322902, 485151083, 3897609680, 2568139623, 874990376, 1013408005, 1077919542, 4145634339, 865055335,
		1642758902, 1080041743, 4233933545, 3625069543, 1716989199, 655320406, 3381723878, 3793168070, 1142179747,
		906361324, 1497891963, 241474379, 4100704638, 2401294378, 3012440020, 2584131530, 3372162711, 2469367699,
		327836251, 883734552, 2561833861, 2186192012, 564036143, 1165377577, 810207929, 1955740703, 384207776,
		3180502283, 393203677, 3519372215, 1401648571, 2231525836, 170294671, 4221983878, 1591563519, 3742950429,
		3841967731, 2918730489, 2843625274, 419899166, 2941961130, 333353317, 3612313044, 1240271854, 553400774,
		2508404541, 1995190876, 2932703716, 3170609963, 3837730711, 2178386997, 1560274050, 1763340506, 2071026441,
		1460492815, 2456625176, 1682507230, 1499362266, 2072964871, 2857768182, 3266389638, 1298180994, 2398957926,
		129903865, 909278088, 1288882513, 2161548236, 1639078399, 2244579621, 724258681, 2674552873, 1091436532,
		3549407018, 1439851970, 1508194903, 2423321042, 1381070155, 2308175419, 587098094, 3750313957, 1985611752,
		2539942149, 4017432835, 3555164716, 3844567695, 2702630636, 3862525379, 2395497816, 117275883, 3551001724,
		645178063, 3319294104, 1081473244, 2476129554, 1425560278, 196458056, 2235598125, 2691959225, 3536079367,
		3927456162, 2483890342, 4069229163, 3303983163, 51062475, 258095831, 2456243063, 1291698140, 689255719,
		2811691195, 2480904747, 468359027, 124514583, 1898146132, 1180336862, 670867947, 3108452466, 3204110223,
		2080800887, 208856071, 167812467, 3383582844, 1110705491, 3085252335, 3842542320, 723246712, 1309288972,
		2231666673, 681362930, 1774868301, 3514216942, 2021999044, 2877856941, 9261029, 1243106860, 2237270686,
		3430873075, 1823847612, 1828974256, 876372269, 4265079547, 887328069, 2403245694, 2357753446, 4074480272,
		4067987060, 1662232380, 187612898, 1091304853, 3416167510, 277601770, 3386602349, 3712924141, 113837919,
		617925905, 2545044098, 890396107, 2775531818, 484731742, 2048038720, 1788937153, 2433593810, 224964672,
		1142268752, 380866312, 4007498524, 2099970256, 1399420293, 347956216, 3081322143, 4103430160, 687384850,
		372375910, 61044495, 1436902360, 2645578060, 3187007217, 1690249983, 1538733316, 778236582, 1135029672,
		639415005, 360448325, 215303020, 3301731734, 1193857094, 1137714090, 999070272, 2577119845, 1246089077,
		2200426005, 203279855, 71246288, 706859265, 877927620, 406732739, 513928836, 2252143791, 1182510542,
		3557241500, 3074004332, 1072599050, 2509330182, 46777190, 975119464, 634437997, 756281044, 1665686622,
		373023100, 3432481829, 2449170505, 2774508414, 1525249295, 4144912198, 4093100811, 3203390174, 3980752304,
		4107130926, 3016278343, 652627368, 2737597115, 1178295446, 3331382452, 271241217, 1820483863, 870821908,
		1710440723, 450338523, 907893219, 51600604, 683212878, 2386135437, 3553013294, 3552185515, 4193702187,
		3598571734, 863370436, 2305551670, 969259878, 1439253503, 628265297, 788670960, 2081611919, 3585205485,
		1184063998, 971747762, 2780970936, 2333126743, 2562672990, 3939839890, 1544227168, 994374893, 3730687017,
		133894732, 3480607191, 443548517, 4222106636, 3377469661, 4019971751, 1212387080, 3371020359, 1995495948,
		4136836795, 3815436856, 316458125, 3668048896, 1824761522, 600362900, 2456428752, 2621391866, 225387098,
		4064680641, 17710349, 1164402269, 1692590378, 2426791491, 4186852989, 792314088, 3547996379, 2160073307,
		1453152567, 3414889825, 3794091536, 3241816045, 3453842027, 3421463698, 985448961, 4129563209, 2237557172,
		3901388157, 2868061777, 2142131689, 1359338629, 2904680630, 3007686946, 1491333078, 73596391, 707837894,
		2408243532, 1417614032, 477182774, 1585862592, 678054130, 1853385838, 2977702764, 1127676447, 3631368441,
		396982235, 1128398926, 2517634663, 2355571612, 737550546, 1375988768, 2595076016, 600318807, 289434376,
		2245835479, 2077962083, 1341880727, 3341466646, 3232412753, 1599901254, 2871528911, 3368534311, 2552529327,
		390602620, 1745073173, 1563242245, 3531201445, 1679858649, 3710492479, 3949700601, 1778592460, 3019284519,
		303992372, 1819363620, 2751026240, 193899772, 4279337393, 2227156664, 3528771660, 1535260802, 489332389,
		738510127, 3157472159, 2877037941, 3598448355, 1286270967, 3845269029, 840740384, 2417217094, 26218975,
		2241893489, 1283873739, 1088744615, 1842442415, 902947475, 2961825424, 3651155479, 3165597574, 868346528,
		2656962834, 3086086258, 761458211, 941872229, 3558490285, 2519314229, 1163202768, 461810874, 4177070398,
		3137692055, 2516565089, 2214923254, 817183128, 1091383902, 1937929177, 181407449, 401222698, 5225861,
		3886457186, 2137169771, 3166871879, 3350743650, 971310639, 3400947592, 3621090994, 1840959328, 2245413344,
		987141373, 3671490587, 3009730977, 4187910137, 527303517, 3020285869, 2592615030, 1733797092, 3891021733,
		2891612296, 3979474111, 3723846785, 2243053920, 4169445798, 4081927991, 1898140873, 2263910926, 870850473,
		3647285146, 3177420386, 900362518, 4108461246, 2063916971, 537245254, 1054008471, 218767029, 1339843932,
		1589257964, 796938952, 2774038166, 347824421, 37114520, 430946241, 3246275748, 3458444553, 1937846607,
		276287545, 1255553796, 2314211620, 2443214579, 2248430223, 4029973222, 427982775, 3030913330, 145595189,
		1449980388, 2082162364, 1922017623, 2411301893, 144763453, 537747879, 1676141739, 3111047573, 3834808460,
		1383433738, 3177618646, 3081872789, 4130663349, 2407229244, 2355224249, 4225849426, 1224204321, 2534866725,
		3991563511, 2251395270, 718780595, 3222985474, 483537784, 2409471316, 1595076590, 2352898079, 324634926,
		385378549, 1636119017, 2583288809, 928704062, 3566728490, 377382345, 1288699469, 2725175370, 3948074746,
		394298656, 3982487757, 2149175324, 3442435981, 1879697036, 3225316246, 300330007, 2125828789, 1257236203,
		4185241659, 2244978553, 2911898713, 3345481460, 3351649735, 3044046128, 3322190823, 1148468355, 2818516335,
		1889332957, 1265424124, 1070523052, 130203426, 885045307, 1725584422, 1960981658, 579259012, 516995482,
		2053229840, 3897847985, 1627977745, 4117149228, 4156115841, 1766820824, 2935845209, 4253262643, 3854329935,
		3063904473, 197542281, 2317612422, 3487727103, 891281341, 3458597196, 1773578110, 738486555, 3081383691,
		2528331635, 371140156, 4120151234, 2146683682, 1944688199, 1704696790, 1786539338, 3688867052, 3511184717,
		1080368058, 3506786370, 3025525254, 2763459484, 3791471216, 2269200439, 3206264005, 1271079064, 1617022493,
		3101450395, 3062200002, 3216951731, 3999343381, 4093126814, 2506371143, 1838156133, 3303725740, 4279082883,
		2818220677, 4243064890, 425008523, 636023020, 369335944, 1977698815, 3600610690, 2388972060, 3558796069,
		1920156019, 2134739165, 836191024, 3541182276, 3894578892, 1106026797, 128591457, 2091048322, 368938377,
		2497041548, 3780297440, 1258984951, 2769653586, 2470679593, 1442012919, 1192854371, 3968416186, 3744751278,
		2585950501, 1183264270, 2935964942, 477866635, 1939402687, 1485664464, 1995176500, 3087061330, 2556153504,
		181380499, 1177454054, 2031514262, 3846298334, 3547263544, 971810738, 1221370302, 1697884690, 2232770676,
		801727580, 1974986433, 334695695, 1349262259, 787737646, 1009582110, 3003137229, 3284233379, 904659640,
		3643621048, 1346713908, 3076037321, 889230496, 1344012474, 2815942348, 502571211, 646487924, 4243571098,
		1564467210, 1398221865, 128879762, 1938281137, 2264353048, 2982139130, 3932730137, 2510979311, 1624634025,
		2474174380, 2537464749, 1799460048, 2703130763, 580215834, 4162656213, 2633904658, 2909201722, 823888881,
		1309771161, 1446046788, 3763397338, 620630492, 4232057729, 2078260595, 4093036578, 1739111237, 1718756337,
		3308101126, 3469681436, 3090827942, 1615289909, 656640937, 2392716036, 1748805858, 3737865668, 1629198073,
		2220663478, 3814279940, 579706468, 2507731889, 2135124091, 2295469036, 3536859955, 1309428869, 1693232279,
		616646178, 1248903606, 986241315, 36602363, 1492443035, 1077684788, 1086358342, 1232918371, 3852061161,
		1912325506, 3075305289, 1278535024, 3044694458, 676459698, 1490911910, 2314290213, 2760766477, 3774484120,
		1717232300, 181128738, 3688656815, 756230451, 2485162090, 1556545771, 2450201722, 971135187, 3495209168,
		3284894260, 451734730, 1809883729, 2393670505, 784669511, 1140252100, 1223795287, 1500800826, 2577661540,
		1476500596, 2506422511, 3491790428, 4282075965, 151254790, 3530533432, 1115960486, 568925960, 835351005,
		2148082688, 3607124825, 2505444219, 3611084904, 898724018, 299191673, 1381386137, 303558374, 1396765299,
		4127533996, 4063960862, 1153494926, 997641075, 3291400439, 974240971, 126545696, 4150751259, 3204170241,
		3348443964, 613639973, 2513746525, 2933570534, 4210385819, 4163858310, 3857970530, 2390344010, 75895295,
		2932460148, 290534311, 2788103482, 2685077319, 1679025000, 3758131533, 3407028207, 3436234973, 582702074,
		1027073895, 2256616487, 1066929786, 2933460224, 237589362, 827027835, 2667331052, 3985636507, 3622451699,
		1341060922, 3774512136, 1358631813, 732357048, 2651312085, 2162584324, 3637816646, 3566902320, 3041644991,
		2642139769, 1867088650, 4007456830, 2975938084, 3351210882, 4099282962, 3483269117, 1410852450, 814654867,
		3557600725, 325136991, 2183762442, 2831573134, 90784860, 3437941789, 30585005, 2643547135, 2672831942,
		578125605, 2146915775, 3261928701, 727947177, 1633335122, 1125579312, 874627987, 2181938279, 380747998,
		3257461188, 3672710185, 2983078563, 2356050504, 3559530384, 3682803852, 2495616840, 3375249923, 3509367796,
		572341996, 2267341981, 2126095346, 4059552813, 1365856448, 2733124863, 1620708997, 1652649613, 2457435139,
		3594729634, 1903192475, 2254716396, 837899453, 2828954649, 3628868257, 2832402892, 1302237848, 3731133654,
		2672105523, 3597951022, 4203593825, 2920302987, 4180990424, 3454432435, 278669572, 978455978, 520492270,
		4099995475, 3454591808, 361002481, 1855683375, 1064263190, 169429386, 2772007456, 3845952641, 776312062,
		3985476527, 3771279083, 2093776973, 2162255454, 3920744333, 1841930598, 4101747621, 3532641380, 1146547095,
		3160792604, 485448198, 1713806172, 230721234, 2050219430, 1207369341, 707259113, 4070430367, 3554172070,
		855614337, 3065111150, 1714333623, 474674651, 2209465383, 193880333, 4131045760, 3197318846, 1166034751,
		1613931166, 2885573808, 2935801781, 3431743597, 2262266712, 1604916539, 4223990486,
	}

	res := p1.Multiply(p1)

	if !reflect.DeepEqual(res, expectedRes) {
		t.Errorf("polynomial multiplication failed\n\nexpected %v\n\ngot %v\n", expectedRes, res)
	}
}

func TestBitReverse(t *testing.T) {
	inp := 256

	expected := 1

	ans := BitReverse(inp, MostSignificantBitIndex(inp))
	if ans != expected {
		t.Errorf("reversal failed, expected %v, got %v\n", expected, ans)
	}
}

func TestNussbaumerIterativePolynomial(t *testing.T) {
	inp := []uint32 { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 }

	expected := [][]uint32 {
		[]uint32 { 0, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 8, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 4, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 12, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 2, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 10, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 6, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 14, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 1, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 9, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 5, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 13, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 3, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 11, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 7, 0, 0, 0, 0, 0, 0, 0 },
		[]uint32 { 15, 0, 0, 0, 0, 0, 0, 0 },
	}

	ans := NussbaumerIterativePolynomial(inp)

	if !reflect.DeepEqual(ans, expected) {
		t.Errorf("reversal failed, expected %v, got %v\n", expected, ans)
	}

}

func TestModularRound(t *testing.T) {
	longPolynomial := make(LongPolynomial, 1024)

	//	longPolynomial[0] = int64(NumMod)
	longPolynomial[0] = int64(NumMod>>2) - 1
	longPolynomial[1] = int64(NumMod) - 3
	longPolynomial[2] = 2

	expectedRes := make(Polynomial, 1024)

	res0 := math.Round(2.0 * (float64(AdjustPositiveNegative(int64(NumMod>>2) - 1))) / float64(LongMod))
	res1 := math.Round(2.0 * (float64(AdjustPositiveNegative(int64(NumMod) - 3))) / float64(LongMod))
	res2 := math.Round(2.0 * -2 / float64(LongMod))

	expectedRes[0] = uint32(res0)
	expectedRes[1] = uint32(res1)
	expectedRes[2] = uint32(res2)

	res := longPolynomial.ModularRound()

	if !reflect.DeepEqual(res, expectedRes) {
		t.Errorf("polynomial modular round failed, expected %v but got %v\n", expectedRes, res)
	}
}

func TestCrossRound(t *testing.T) {
	longPolynomial := make(LongPolynomial, 1024)

	longPolynomial[0] = CrossRoundQ4 - 5
	longPolynomial[1] = CrossRoundQ4
	longPolynomial[2] = CrossRoundQ4 + 5
	longPolynomial[3] = CrossRoundQ2 - 5
	longPolynomial[4] = CrossRoundQ2
	longPolynomial[5] = CrossRoundQ2 + 5
	longPolynomial[6] = CrossRoundQ2 + CrossRoundQ4 - 5
	longPolynomial[7] = CrossRoundQ2 + CrossRoundQ4
	longPolynomial[8] = CrossRoundQ2 + CrossRoundQ4 + 5

	expectedRes := make(Polynomial, 1024)
	expectedRes[0] = uint32(math.Floor(4.0*float64(longPolynomial[0])/float64(LongMod))) % 2
	expectedRes[1] = uint32(math.Floor(4.0*float64(longPolynomial[1])/float64(LongMod))) % 2
	expectedRes[2] = uint32(math.Floor(4.0*float64(longPolynomial[2])/float64(LongMod))) % 2
	expectedRes[3] = uint32(math.Floor(4.0*float64(longPolynomial[3])/float64(LongMod))) % 2
	expectedRes[4] = uint32(math.Floor(4.0*float64(longPolynomial[4])/float64(LongMod))) % 2
	expectedRes[5] = uint32(math.Floor(4.0*float64(longPolynomial[5])/float64(LongMod))) % 2
	expectedRes[6] = uint32(math.Floor(4.0*float64(longPolynomial[6])/float64(LongMod))) % 2
	expectedRes[7] = uint32(math.Floor(4.0*float64(longPolynomial[7])/float64(LongMod))) % 2
	expectedRes[8] = uint32(math.Floor(4.0*float64(longPolynomial[8])/float64(LongMod))) % 2

	res := longPolynomial.CrossRound()

	if !reflect.DeepEqual(res, expectedRes) {
		t.Errorf("polynomial modular round failed, expected %v but got %v\n", expectedRes, res)
	}
}

// Note: not 100% uniform over the error, used only for testing
func SufficientlyCloseLongMod(n int64) int64 {
	randomBit := int64(utils.RandomBit())
	randomAbsError := EnsureLongMod(utils.RandomInt64(utils.NewRandomGenerator())) >> 4

	randomError := (randomAbsError&-1 + randomBit) | (LongModNeg(randomAbsError) & -randomBit)

	return LongModAdd(n, randomError)
}

func SufficientlyCloseLongPolynomial(lp LongPolynomial) LongPolynomial {
	res := make(LongPolynomial, len(lp))

	for i := range lp {
		res[i] = SufficientlyCloseLongMod(lp[i])
	}

	return res
}

func TestReconciliate(t *testing.T) {
	cases := 2000

	for i := 0; i < cases; i++ {
		v := EnsureLongMod(utils.RandomInt64(utils.NewRandomGenerator()))
		w := SufficientlyCloseLongMod(v)

		crv := CrossRound(v)
		mrv := ModularRound(v)

		res := Reconciliate(w, crv)

		if res != mrv {
			t.Errorf(`
				Reconciliation failed
				v = %v
				w = %v
				crv = %v
				mrv = %v
				res = Reconciliate(%v, %v) = %v
				`,
				v,
				w,
				crv,
				mrv,
				w,
				crv,
				res,
			)
			return
		}
	}

}

func TestPolynomialReconciliate(t *testing.T) {
	cases := 1000

	for c := 0; c < cases; c++ {
		v := NewRandomLongPolynomial()
		w := SufficientlyCloseLongPolynomial(v)

		crv := v.CrossRound()

		mrv := v.ModularRound()

		res := w.Reconciliate(crv)

		if !reflect.DeepEqual(res, mrv) {
			t.Errorf("polynomial reconciliation failed\ncrv = %v\nrecon = %v\n", crv, res)

			var diffCount int

			for i := range res {
				if res[i] != mrv[i] {
					diffCount++
				}
			}

			t.Logf("diffCount = %v\n", diffCount)
			return
		}
	}
}
